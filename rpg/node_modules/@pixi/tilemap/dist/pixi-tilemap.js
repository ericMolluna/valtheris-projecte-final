"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const d=require("@pixi/core"),K=require("@pixi/display");class C{constructor(t){this.tileAnim=[0,0],this.dontUseTransform=!1,this.renderer=t,this.tileAnim=[0,0]}static registerExtension(){d.extensions.add({name:"tilemap",type:d.ExtensionType.CanvasRendererPlugin,ref:C})}static getInstance(t){if(!t.plugins.tilemap)throw new Error("Extension not registered!");return t.plugins.tilemap}}const p={TEXTURES_PER_TILEMAP:16,TEXTILE_DIMEN:1024,TEXTILE_UNITS:1,TEXTILE_SCALE_MODE:d.SCALE_MODES.LINEAR,use32bitIndex:!1,DO_CLEAR:!0,get maxTextures(){return this.MAX_TEXTURES},set maxTextures(o){this.MAX_TEXTURES=o},get boundSize(){return this.TEXTURE_TILE_DIMEN},set boundSize(o){this.TILE_TEXTURE_DIMEN=o},get boundCountPerBuffer(){return this.TEXTILE_UNITS},set boundCountPerBuffer(o){this.TEXTILE_UNITS=o}},J=p;var tt=(o=>(o[o.U=0]="U",o[o.V=1]="V",o[o.X=2]="X",o[o.Y=3]="Y",o[o.TILE_WIDTH=4]="TILE_WIDTH",o[o.TILE_HEIGHT=5]="TILE_HEIGHT",o[o.ROTATE=6]="ROTATE",o[o.ANIM_X=7]="ANIM_X",o[o.ANIM_Y=8]="ANIM_Y",o[o.TEXTURE_INDEX=9]="TEXTURE_INDEX",o[o.ANIM_COUNT_X=10]="ANIM_COUNT_X",o[o.ANIM_COUNT_Y=11]="ANIM_COUNT_Y",o[o.ANIM_DIVISOR=12]="ANIM_DIVISOR",o[o.ALPHA=13]="ALPHA",o))(tt||{});const y=Object.keys(tt).length/2;class D extends K.Container{constructor(t){super(),this.shadowColor=new Float32Array([0,0,0,.5]),this._globalMat=null,this.tileAnim=null,this.modificationMarker=0,this.offsetX=0,this.offsetY=0,this.compositeParent=!1,this.tilemapBounds=new K.Bounds,this.hasAnimatedTile=!1,this.pointsBuf=[],this.renderCanvas=e=>{const i=C.getInstance(e);if(i&&!i.dontUseTransform){const s=this.worldTransform;e.canvasContext.activeContext.setTransform(s.a,s.b,s.c,s.d,s.tx*e.resolution,s.ty*e.resolution)}this.renderCanvasCore(e)},this.vbId=0,this.vb=null,this.vbBuffer=null,this.vbArray=null,this.vbInts=null,this.setTileset(t)}getTileset(){return this.tileset}setTileset(t=[]){Array.isArray(t)||(t=[t]);for(let e=0;e<t.length;e++)t[e].baseTexture&&(t[e]=t[e].baseTexture);return this.tileset=t,this}clear(){return this.pointsBuf.length=0,this.modificationMarker=0,this.tilemapBounds.clear(),this.hasAnimatedTile=!1,this}tile(t,e,i,s={}){let a,u=-1;if(typeof t=="number")u=t,a=this.tileset[u];else{let b;typeof t=="string"?b=d.Texture.from(t):b=t;const L=this.tileset;for(let v=0;v<L.length;v++)if(L[v]===b.castToBaseTexture()){u=v;break}"baseTexture"in b&&(s.u=s.u??b.frame.x,s.v=s.v??b.frame.y,s.tileWidth=s.tileWidth??b.orig.width,s.tileHeight=s.tileHeight??b.orig.height),a=b.castToBaseTexture()}if(!a||u<0)return console.error("The tile texture was not found in the tilemap tileset."),this;const{u:l=0,v:h=0,tileWidth:c=a.realWidth,tileHeight:f=a.realHeight,animX:T=0,animY:r=0,rotate:n=0,animCountX:A=1024,animCountY:w=1024,animDivisor:B=1,alpha:m=1}=s,E=this.pointsBuf;return this.hasAnimatedTile=this.hasAnimatedTile||T>0||r>0,E.push(l),E.push(h),E.push(e),E.push(i),E.push(c),E.push(f),E.push(n),E.push(T|0),E.push(r|0),E.push(u),E.push(A),E.push(w),E.push(B),E.push(m),this.tilemapBounds.addFramePad(e,i,e+c,i+f,0,0),this}tileRotate(t){const e=this.pointsBuf;e[e.length-(y-9)]=t}tileAnimX(t,e){const i=this.pointsBuf;i[i.length-(y-7)]=t,i[i.length-(y-10)]=e}tileAnimY(t,e){const i=this.pointsBuf;i[i.length-(y-8)]=t,i[i.length-(y-11)]=e}tileAnimDivisor(t){const e=this.pointsBuf;e[e.length-(y-12)]=t}tileAlpha(t){const e=this.pointsBuf;e[e.length-(y-13)]=t}renderCanvasCore(t){if(this.tileset.length===0)return;const e=this.pointsBuf,i=this.tileAnim||t.plugins.tilemap&&t.plugins.tilemap.tileAnim;t.canvasContext.activeContext.fillStyle="#000000";for(let s=0,a=e.length;s<a;s+=y){let u=e[s+0],l=e[s+1];const h=e[s+2],c=e[s+3],f=e[s+4],T=e[s+5];u+=e[s+7]*i[0],l+=e[s+8]*i[1];const r=e[s+9],n=e[s+13];r>=0&&this.tileset[r]?(t.canvasContext.activeContext.globalAlpha=n,t.canvasContext.activeContext.drawImage(this.tileset[r].getDrawableSource(),u,l,f,T,h,c,f,T)):(t.canvasContext.activeContext.globalAlpha=.5,t.canvasContext.activeContext.fillRect(h,c,f,T)),t.canvasContext.activeContext.globalAlpha=1}}destroyVb(){this.vb&&(this.vb.destroy(),this.vb=null)}render(t){const e=t.plugins.tilemap,i=e.getShader();t.batch.setObjectRenderer(e),this._globalMat=i.uniforms.projTransMatrix,t.globalUniforms.uniforms.projectionMatrix.copyTo(this._globalMat).append(this.worldTransform),i.uniforms.shadowColor=this.shadowColor,i.uniforms.animationFrame=this.tileAnim||e.tileAnim,this.renderWebGLCore(t,e)}renderWebGLCore(t,e){const i=this.pointsBuf;if(i.length===0)return;const s=i.length/y,a=e.getShader(),u=this.tileset;if(u.length===0)return;e.bindTileTextures(t,u),t.shader.bind(a,!1);let l=this.vb;l||(l=e.createVb(),this.vb=l,this.vbId=l.id,this.vbBuffer=null,this.modificationMarker=0),e.checkIndexBuffer(s,l);const h=p.TEXTILE_UNITS,c=l.getBuffer("aVertexPosition"),f=s*l.vertPerQuad;if(f!==0){if(this.modificationMarker!==f){this.modificationMarker=f;const T=l.stride*f;if(!this.vbBuffer||this.vbBuffer.byteLength<T){let m=l.stride;for(;m<T;)m*=2;this.vbBuffer=new ArrayBuffer(m),this.vbArray=new Float32Array(this.vbBuffer),this.vbInts=new Uint32Array(this.vbBuffer),c.update(this.vbBuffer)}const r=this.vbArray;let n=0,A=0,w=this.offsetX,B=this.offsetY;for(let m=0;m<i.length;m+=y){if(this.compositeParent){const M=i[m+9];h>1?(A=M>>2,w=this.offsetX*(M&1),B=this.offsetY*(M>>1&1)):(A=M,w=0,B=0)}const b=i[m+2],L=i[m+3],v=i[m+4],_=i[m+5],x=i[m+0]+w,I=i[m+1]+B;let g=i[m+6];const st=i[m+7],rt=i[m+8],nt=i[m+10]||1024,at=i[m+11]||1024,S=st+nt*2048,F=rt+at*2048,R=i[m+12],Y=i[m+13];let V,j,G,z,O,$,Q,q;if(g===0)V=x,j=I,G=x+v,z=I,O=x+v,$=I+_,Q=x,q=I+_;else{let M=v/2,X=_/2;g%4!==0&&(M=_/2,X=v/2);const N=x+M,P=I+X;g=d.groupD8.add(g,d.groupD8.NW),V=N+M*d.groupD8.uX(g),j=P+X*d.groupD8.uY(g),g=d.groupD8.add(g,2),G=N+M*d.groupD8.uX(g),z=P+X*d.groupD8.uY(g),g=d.groupD8.add(g,2),O=N+M*d.groupD8.uX(g),$=P+X*d.groupD8.uY(g),g=d.groupD8.add(g,2),Q=N+M*d.groupD8.uX(g),q=P+X*d.groupD8.uY(g)}r[n++]=b,r[n++]=L,r[n++]=V,r[n++]=j,r[n++]=x+.5,r[n++]=I+.5,r[n++]=x+v-.5,r[n++]=I+_-.5,r[n++]=S,r[n++]=F,r[n++]=A,r[n++]=R,r[n++]=Y,r[n++]=b+v,r[n++]=L,r[n++]=G,r[n++]=z,r[n++]=x+.5,r[n++]=I+.5,r[n++]=x+v-.5,r[n++]=I+_-.5,r[n++]=S,r[n++]=F,r[n++]=A,r[n++]=R,r[n++]=Y,r[n++]=b+v,r[n++]=L+_,r[n++]=O,r[n++]=$,r[n++]=x+.5,r[n++]=I+.5,r[n++]=x+v-.5,r[n++]=I+_-.5,r[n++]=S,r[n++]=F,r[n++]=A,r[n++]=R,r[n++]=Y,r[n++]=b,r[n++]=L+_,r[n++]=Q,r[n++]=q,r[n++]=x+.5,r[n++]=I+.5,r[n++]=x+v-.5,r[n++]=I+_-.5,r[n++]=S,r[n++]=F,r[n++]=A,r[n++]=R,r[n++]=Y}c.update(r)}t.geometry.bind(l,a),t.geometry.draw(d.DRAW_MODES.TRIANGLES,s*6,0)}}isModified(t){return!!(this.modificationMarker!==this.pointsBuf.length||t&&this.hasAnimatedTile)}clearModify(){this.modificationMarker=this.pointsBuf.length}_calculateBounds(){const{minX:t,minY:e,maxX:i,maxY:s}=this.tilemapBounds;this._bounds.addFrame(this.transform,t,e,i,s)}getLocalBounds(t){return this.children.length===0?this.tilemapBounds.getRectangle(t):super.getLocalBounds.call(this,t)}destroy(t){super.destroy(t),this.destroyVb()}addFrame(t,e,i,s,a){return this.tile(t,e,i,{animX:s,animY:a}),!0}addRect(t,e,i,s,a,u,l,h=0,c=0,f=0,T=1024,r=1024,n=1,A=1){return this.tile(t,s,a,{u:e,v:i,tileWidth:u,tileHeight:l,animX:h,animY:c,rotate:f,animCountX:T,animCountY:r,animDivisor:n,alpha:A})}}class k extends K.Container{constructor(t){super(),this.tileAnim=null,this.lastModifiedTilemap=null,this.modificationMarker=0,this.shadowColor=new Float32Array([0,0,0,.5]),this._globalMat=null,this.setBitmaps=this.tileset,this.tileset(t),this.texturesPerTilemap=p.TEXTURES_PER_TILEMAP}tileset(t){t||(t=[]);const e=this.texturesPerTilemap,i=this.children.length,s=Math.ceil(t.length/e);for(let a=0;a<Math.min(i,s);a++)this.children[a].setTileset(t.slice(a*e,(a+1)*e));for(let a=i;a<s;a++){const u=new D(t.slice(a*e,(a+1)*e));u.compositeParent=!0,u.offsetX=p.TEXTILE_DIMEN,u.offsetY=p.TEXTILE_DIMEN,this.addChild(u)}return this}clear(){for(let t=0;t<this.children.length;t++)this.children[t].clear();return this.modificationMarker=0,this}tileRotate(t){return this.lastModifiedTilemap&&this.lastModifiedTilemap.tileRotate(t),this}tileAnimX(t,e){return this.lastModifiedTilemap&&this.lastModifiedTilemap.tileAnimX(t,e),this}tileAnimY(t,e){return this.lastModifiedTilemap&&this.lastModifiedTilemap.tileAnimY(t,e),this}tileAnimDivisor(t){return this.lastModifiedTilemap&&this.lastModifiedTilemap.tileAnimDivisor(t),this}tile(t,e,i,s={}){let a=null;const u=this.children;if(this.lastModifiedTilemap=null,typeof t=="number"){const l=t/this.texturesPerTilemap>>0;let h=0;if(a=u[l],a)h=t%this.texturesPerTilemap;else{if(a=u[0],!a)return this;h=0}a.tile(h,e,i,s)}else{typeof t=="string"&&(t=d.Texture.from(t));for(let l=0;l<u.length;l++){const h=u[l],c=h.getTileset();for(let f=0;f<c.length;f++)if(c[f]===t.baseTexture){a=h;break}if(a)break}if(!a){for(let l=u.length-1;l>=0;l--){const h=u[l];if(h.getTileset().length<this.texturesPerTilemap){a=h,h.getTileset().push(t.baseTexture);break}}a||(a=new D(t.baseTexture),a.compositeParent=!0,a.offsetX=p.TEXTILE_DIMEN,a.offsetY=p.TEXTILE_DIMEN,this.addChild(a))}a.tile(t,e,i,s)}return this.lastModifiedTilemap=a,this}renderCanvas(t){if(!this.visible||this.worldAlpha<=0||!this.renderable)return;const e=C.getInstance(t);if(e&&!e.dontUseTransform){const s=this.worldTransform;t.canvasContext.activeContext.setTransform(s.a,s.b,s.c,s.d,s.tx*t.resolution,s.ty*t.resolution)}const i=this.children;for(let s=0;s<i.length;s++){const a=i[s];a.tileAnim=this.tileAnim,a.renderCanvasCore(t)}}render(t){if(!this.visible||this.worldAlpha<=0||!this.renderable)return;const e=t.plugins.tilemap,i=e.getShader();t.batch.setObjectRenderer(e),this._globalMat=i.uniforms.projTransMatrix,t.globalUniforms.uniforms.projectionMatrix.copyTo(this._globalMat).append(this.worldTransform),i.uniforms.shadowColor=this.shadowColor,i.uniforms.animationFrame=this.tileAnim||e.tileAnim,t.shader.bind(i,!1);const s=this.children;for(let a=0;a<s.length;a++)s[a].renderWebGLCore(t,e)}isModified(t){const e=this.children;if(this.modificationMarker!==e.length)return!0;for(let i=0;i<e.length;i++)if(e[i].isModified(t))return!0;return!1}clearModify(){const t=this.children;this.modificationMarker=t.length;for(let e=0;e<t.length;e++)t[e].clearModify()}addFrame(t,e,i,s,a,u,l,h,c){return this.tile(t,e,i,{animX:s,animY:a,animCountX:u,animCountY:l,animDivisor:h,alpha:c})}addRect(t,e,i,s,a,u,l,h,c,f,T,r){const n=t/this.texturesPerTilemap>>0,A=t%this.texturesPerTilemap;return this.children[n]&&this.children[n].getTileset()?(this.lastModifiedTilemap=this.children[n],this.lastModifiedTilemap.addRect(A,e,i,s,a,u,l,h,c,f,T,r)):this.lastModifiedTilemap=null,this}get texPerChild(){return this.texturesPerTilemap}}class H extends d.Resource{constructor(t=p){super(t.TEXTILE_DIMEN*2,t.TEXTILE_DIMEN*Math.ceil(t.TEXTILE_UNITS/2)),this.baseTexture=null,this._clearBuffer=null;const e=this.tiles=new Array(t.TEXTILE_UNITS);this.doClear=!!t.DO_CLEAR,this.tileDimen=t.TEXTILE_DIMEN;for(let i=0;i<t.TEXTILE_UNITS;i++)e[i]={dirtyId:0,x:t.TEXTILE_DIMEN*(i&1),y:t.TEXTILE_DIMEN*(i>>1),baseTexture:d.Texture.WHITE.baseTexture}}tile(t,e){const i=this.tiles[t];i.baseTexture!==e&&(i.baseTexture=e,this.baseTexture.update(),this.tiles[t].dirtyId=this.baseTexture.dirtyId)}bind(t){if(this.baseTexture)throw new Error("Only one baseTexture is allowed for this resource!");this.baseTexture=t,super.bind(t)}upload(t,e,i){const{gl:s}=t,{width:a,height:u}=this;s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.alphaMode===void 0||e.alphaMode===d.ALPHA_MODES.UNPACK),i.dirtyId<0&&(i.width=a,i.height=u,s.texImage2D(e.target,0,e.format,a,u,0,e.format,e.type,null));const l=this.doClear,h=this.tiles;l&&!this._clearBuffer&&(this._clearBuffer=new Uint8Array(p.TEXTILE_DIMEN*p.TEXTILE_DIMEN*4));for(let c=0;c<h.length;c++){const f=h[c],T=f.baseTexture;if(i.dirtyId>=this.tiles[c].dirtyId)continue;const r=T.resource;!T.valid||!r||!r.source||(l&&(T.width<this.tileDimen||T.height<this.tileDimen)&&s.texSubImage2D(e.target,0,f.x,f.y,this.tileDimen,this.tileDimen,e.format,e.type,this._clearBuffer),s.texSubImage2D(e.target,0,f.x,f.y,e.format,e.type,r.source))}return!0}}function ot(o){let t="";t+=`
`,t+=`
`,t+="if(vTextureId <= -1.0) {",t+=`
	color = shadowColor;`,t+=`
}`;for(let e=0;e<o;e++)t+=`
else `,e<o-1&&(t+=`if(textureId == ${e}.0)`),t+=`
{`,t+=`
	color = texture2D(uSamplers[${e}], textureCoord * uSamplerSize[${e}]);`,t+=`
}`;return t+=`
`,t+=`
`,t}function et(o,t){const e=[];for(let s=0;s<t;s++)e[s]=s;o.uniforms.uSamplers=e;const i=[];for(let s=0;s<t;s++)i.push(1/2048),i.push(1/2048);o.uniforms.uSamplerSize=i}function it(o,t){return t.replace(/%count%/gi,`${o}`).replace(/%forloop%/gi,ot(o))}const lt=`#version 100
precision highp float;
attribute vec2 aVertexPosition;
attribute vec2 aTextureCoord;
attribute vec4 aFrame;
attribute vec2 aAnim;
attribute float aAnimDivisor;
attribute float aTextureId;
attribute float aAlpha;

uniform mat3 projTransMatrix;
uniform vec2 animationFrame;

varying vec2 vTextureCoord;
varying float vTextureId;
varying vec4 vFrame;
varying float vAlpha;

void main(void)
{
   gl_Position = vec4((projTransMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);
   vec2 animCount = floor((aAnim + 0.5) / 2048.0);
   vec2 animFrameOffset = aAnim - animCount * 2048.0;
   vec2 currentFrame = floor(animationFrame / aAnimDivisor);
   vec2 animOffset = animFrameOffset * floor(mod(currentFrame + 0.5, animCount));

   vTextureCoord = aTextureCoord + animOffset;
   vFrame = aFrame + vec4(animOffset, animOffset);
   vTextureId = aTextureId;
   vAlpha = aAlpha;
}
`,ht=`#version 100
#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
varying vec2 vTextureCoord;
varying vec4 vFrame;
varying float vTextureId;
varying float vAlpha;
uniform vec4 shadowColor;
uniform sampler2D uSamplers[%count%];
uniform vec2 uSamplerSize[%count%];

void main(void)
{
   vec2 textureCoord = clamp(vTextureCoord, vFrame.xy, vFrame.zw);
   float textureId = floor(vTextureId + 0.5);

   vec4 color;
   %forloop%
   gl_FragColor = color * vAlpha;
}
`;class U extends d.Shader{constructor(t){super(new d.Program(lt,it(t,ht)),{animationFrame:new Float32Array(2),uSamplers:[],uSamplerSize:[],projTransMatrix:new d.Matrix}),this.maxTextures=0,this.maxTextures=t,et(this,this.maxTextures)}}class W extends d.Geometry{constructor(){super(),this.vertSize=13,this.vertPerQuad=4,this.stride=this.vertSize*4,this.lastTimeAccess=0;const t=this.buf=new d.Buffer(new Float32Array(2),!0,!1);this.addAttribute("aVertexPosition",t,0,!1,0,this.stride,0).addAttribute("aTextureCoord",t,0,!1,0,this.stride,2*4).addAttribute("aFrame",t,0,!1,0,this.stride,4*4).addAttribute("aAnim",t,0,!1,0,this.stride,8*4).addAttribute("aTextureId",t,0,!1,0,this.stride,10*4).addAttribute("aAnimDivisor",t,0,!1,0,this.stride,11*4).addAttribute("aAlpha",t,0,!1,0,this.stride,12*4)}}class Z extends d.ObjectRenderer{constructor(t){super(t),this.tileAnim=[0,0],this.ibLen=0,this.indexBuffer=null,this.textiles=[],this.shader=new U(p.TEXTURES_PER_TILEMAP),this.indexBuffer=new d.Buffer(void 0,!0,!0),this.checkIndexBuffer(2e3),this.makeTextiles()}bindTileTextures(t,e){const i=e.length,s=this.shader,a=p.TEXTURES_PER_TILEMAP,u=s.uniforms.uSamplerSize;if(!(i>p.TEXTILE_UNITS*a)){if(p.TEXTILE_UNITS<=1)for(let l=0;l<e.length;l++){const h=e[l];if(!h||!h.valid)return;t.texture.bind(e[l],l),u[l*2]=1/e[l].realWidth,u[l*2+1]=1/e[l].realHeight}else{this.makeTextiles();const l=Math.ceil(i/p.TEXTILE_UNITS);for(let h=0;h<i;h++){const c=e[h];if(c&&c.valid){const f=Math.floor(h/p.TEXTILE_UNITS),T=h%p.TEXTILE_UNITS;this.textiles[f].tile(T,c)}}for(let h=0;h<l;h++)t.texture.bind(this.textiles[h].baseTexture,h),u[h*2]=1/this.textiles[h].width,u[h*2+1]=1/this.textiles[h].baseTexture.height}s.uniforms.uSamplerSize=u}}start(){}createVb(){const t=new W;return t.addIndex(this.indexBuffer),t.lastTimeAccess=Date.now(),t}getShader(){return this.shader}destroy(){super.destroy(),this.shader=null}checkIndexBuffer(t,e=null){const i=t*6;i<=this.ibLen||(this.ibLen=i,this.indexBuffer.update(d.utils.createIndicesForQuads(t,p.use32bitIndex?new Uint32Array(t*6):void 0)))}makeTextiles(){if(!(p.TEXTILE_UNITS<=1))for(let t=0;t<p.TEXTILE_UNITS;t++){if(this.textiles[t])continue;const e=new H,i=new d.BaseTexture(e);i.scaleMode=p.TEXTILE_SCALE_MODE,i.wrapMode=d.WRAP_MODES.CLAMP,this.textiles[t]=e}}}const ut={CanvasTileRenderer:C,CompositeRectTileLayer:k,CompositeTilemap:k,Constant:J,TextileResource:H,MultiTextureResource:H,RectTileLayer:D,Tilemap:D,TilemapShader:U,TilemapGeometry:W,RectTileShader:U,RectTileGeom:W,TileRenderer:Z};d.extensions.add({name:"tilemap",type:d.ExtensionType.RendererPlugin,ref:Z});exports.CanvasTileRenderer=C;exports.CompositeRectTileLayer=k;exports.CompositeTilemap=k;exports.Constant=J;exports.POINT_STRUCT_SIZE=y;exports.RectTileLayer=D;exports.TextileResource=H;exports.TileRenderer=Z;exports.Tilemap=D;exports.TilemapGeometry=W;exports.TilemapShader=U;exports.fillSamplers=et;exports.generateFragmentSrc=it;exports.pixi_tilemap=ut;exports.settings=p;
//# sourceMappingURL=pixi-tilemap.js.map
